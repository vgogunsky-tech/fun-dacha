<!doctype html>
<html lang="uk">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Усі товари</title>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <style>
      .container { max-width: 1400px; margin: 0 auto; }
      table img { height: 56px; width: 56px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
      .controls { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; align-items: end; }
      .controls input[type="text"], .controls select { width: 100%; max-width: 100%; }
      .controls { width: 100%; max-width: 100%; box-sizing: border-box; }
      main > section { padding-left: 0; padding-right: 0; }
      @media (min-width: 900px) {
        .controls { grid-template-columns: 2fr 1fr 1fr 1fr auto; }
      }
      @media (max-width: 899px) {
        .controls { grid-template-columns: 1fr; }
      }
      main section:first-of-type form.controls { width: 100%; }
      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; }
      .col-id { width: 64px; }
      .nowrap { white-space: nowrap; }
      .sticky { position: sticky; top: 0; background: #fff; }
      th { position: sticky; top: 0; background: #fff; }
      .muted { color: #666; }
      .status { width: 28px; text-align: left; }
      .bulk-actions { 
        background: #f8f9fa; 
        padding: 16px; 
        border-radius: 8px; 
        margin: 16px 0; 
        display: none; 
      }
      .bulk-actions.show { display: block; }
      .bulk-actions button { margin-right: 12px; }
      .modal { 
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(0,0,0,0.5); 
      }
      .modal.show { display: block; }
      .modal-content { 
        background-color: #fefefe; 
        margin: 15% auto; 
        padding: 20px; 
        border: 1px solid #888; 
        width: 80%; 
        max-width: 500px; 
        border-radius: 8px; 
      }
      .modal-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px; 
      }
      .close { 
        color: #aaa; 
        font-size: 28px; 
        font-weight: bold; 
        cursor: pointer; 
      }
      .close:hover { color: #000; }
      .form-group { margin-bottom: 16px; }
      .form-group label { display: block; margin-bottom: 4px; font-weight: bold; }
      .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
      .modal-actions { 
        display: flex; 
        justify-content: flex-end; 
        gap: 12px; 
        margin-top: 20px; 
      }
      .checkbox-cell { text-align: center; }
      .col-checkbox { width: 40px; }
    </style>
  </head>
  <body>
    <header class="container">
      <h1>Список усіх товарів</h1>
      <p><a href="{{ url_for('index') }}">← До категорій</a></p>
    </header>
    <main class="container">
      <section class="filters-section">
        <form method="get" class="controls">
          <div>
            <label>Пошук за назвою</label>
            <input type="text" name="q" value="{{ q }}" placeholder="Назва (укр)" />
          </div>
          <div>
            <label>Категорія</label>
            <select name="category_id">
              <option value="">Всі</option>
              {% for c in categories %}
                {% if not c.parentId %}
                  <option value="{{ c.id }}" {% if (filter_category or '') == c.id %}selected{% endif %}>{{ c.id }} — {{ c.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Сортування</label>
            <select name="sort">
              <option value="">ID</option>
              <option value="name" {% if sort_key == 'name' %}selected{% endif %}>Назва</option>
              <option value="category" {% if sort_key == 'category' %}selected{% endif %}>Категорія</option>
            </select>
          </div>
          <div>
            <label>Порядок</label>
            <select name="order">
              <option value="asc" {% if sort_order != 'desc' %}selected{% endif %}>За зростанням</option>
              <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>За спаданням</option>
            </select>
          </div>
          <div>
            <button type="submit">Застосувати</button>
            <a class="muted" href="{{ url_for('products_list') }}">Скинути</a>
          </div>
        </form>
      </section>

      <!-- Bulk Actions Section -->
      <section class="bulk-actions" id="bulkActions">
        <h3>Масові дії</h3>
        <p>Вибрано товарів: <span id="selectedCount">0</span></p>
        <button type="button" class="button" onclick="openCategoryModal()">Змінити категорію</button>
        <button type="button" class="button muted" onclick="clearSelection()">Скасувати вибір</button>
      </section>

      <section>
        <table>
          <thead>
            <tr>
              <th class="col-checkbox">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
              </th>
              <th class="status">Статус</th>
              <th class="col-id">ID</th>
              <th class="nowrap">Зображення</th>
              <th class="nowrap">Склад</th>
              {% for f in fields %}
                {% if f != 'id' %}
                  <th>{{ f }}</th>
                {% endif %}
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              {% set return_to = request.full_path %}
              <tr>
                <td class="checkbox-cell">
                  <input type="checkbox" class="product-checkbox" value="{{ r['_pid'] }}" onchange="updateBulkActions()">
                </td>
                <td class="status">
                  {% if r._not_validated %}❗{% else %}✅{% endif %}
                </td>
                <td class="col-id">
                  <a href="{{ url_for('product_by_id', pid=r['_pid']) }}?return_to={{ return_to | urlencode }}">{{ r['id'] }}</a>
                </td>
                <td>
                  <a href="{{ url_for('product_by_id', pid=r['_pid']) }}?return_to={{ return_to | urlencode }}">
                    {% if r._image_url %}
                      <img src="{{ r._image_url }}" alt="image" />
                    {% endif %}
                  </a>
                </td>
                <td>
                  <a href="{{ url_for('inventory_edit', pid=r['_pid']) }}?return_to={{ request.full_path | urlencode }}" class="button">Склад</a>
                </td>
                {% for f in fields %}
                  {% if f != 'id' %}
                    {% set val = r.get(f, '') %}
                    {% if f == 'category_id' %}
                      <td>
                        <a href="{{ url_for('product_by_id', pid=r['_pid']) }}?return_to={{ return_to | urlencode }}">
                          {{ val }}{% if category_name_by_id.get(val) %} — {{ category_name_by_id.get(val) }}{% endif %}
                        </a>
                      </td>
                    {% else %}
                      <td>
                        <a href="{{ url_for('product_by_id', pid=r['_pid']) }}?return_to={{ return_to | urlencode }}">{{ val }}</a>
                      </td>
                    {% endif %}
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    </main>

    <!-- Category Assignment Modal -->
    <div id="categoryModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Змінити категорію для вибраних товарів</h3>
          <span class="close" onclick="closeCategoryModal()">&times;</span>
        </div>
        <form id="bulkCategoryForm" method="post" action="{{ url_for('bulk_update_category') }}">
          <div class="form-group">
            <label for="category_id">Категорія:</label>
            <select id="category_id" name="category_id" required onchange="updateSubcategories()">
              <option value="">Виберіть категорію</option>
              {% for c in categories %}
                {% if not c.parentId %}
                  <option value="{{ c.id }}">{{ c.id }} — {{ c.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="subcategory_id">Підкатегорія:</label>
            <select id="subcategory_id" name="subcategory_id">
              <option value="">Без підкатегорії</option>
            </select>
          </div>
          <input type="hidden" id="selected_products" name="product_ids" value="">
          <div class="modal-actions">
            <button type="button" class="button muted" onclick="closeCategoryModal()">Скасувати</button>
            <button type="submit" class="button">Зберегти</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.checked = selectAll.checked;
        });
        updateBulkActions();
      }

      function updateBulkActions() {
        const checkboxes = document.querySelectorAll('.product-checkbox:checked');
        const bulkActions = document.getElementById('bulkActions');
        const selectedCount = document.getElementById('selectedCount');
        
        if (checkboxes.length > 0) {
          bulkActions.classList.add('show');
          selectedCount.textContent = checkboxes.length;
        } else {
          bulkActions.classList.remove('show');
          selectedCount.textContent = '0';
        }
      }

      function clearSelection() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.product-checkbox');
        
        selectAll.checked = false;
        checkboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
        updateBulkActions();
      }

      function openCategoryModal() {
        const checkboxes = document.querySelectorAll('.product-checkbox:checked');
        if (checkboxes.length === 0) {
          alert('Виберіть товари для зміни категорії');
          return;
        }
        
        const productIds = Array.from(checkboxes).map(cb => cb.value).join(',');
        document.getElementById('selected_products').value = productIds;
        
        const modal = document.getElementById('categoryModal');
        modal.classList.add('show');
      }

      function closeCategoryModal() {
        const modal = document.getElementById('categoryModal');
        modal.classList.remove('show');
      }

      function updateSubcategories() {
        const categoryId = document.getElementById('category_id').value;
        const subcategorySelect = document.getElementById('subcategory_id');
        
        // Clear existing options
        subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
        
        if (categoryId) {
          // Find subcategories for the selected category
          // Get categories from the DOM instead of Jinja2 tojson
          const categoryOptions = document.querySelectorAll('#category_id option');
          const categories = [];
          categoryOptions.forEach(opt => {
            if (opt.value && opt.value !== categoryId) {
              // Check if this is a subcategory of the selected category
              const optionText = opt.textContent;
              if (optionText.includes(' — ')) {
                const parts = optionText.split(' — ');
                if (parts.length === 2) {
                  categories.push({
                    id: opt.value,
                    name: parts[1],
                    parentId: categoryId
                  });
                }
              }
            }
          });
          
          // For now, we'll populate subcategories manually based on known structure
          // This is a fallback approach that doesn't rely on Jinja2 tojson
          if (categoryId === '100') { // Tomatoes
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option><option value="101">101 — Томати високорослі</option><option value="102">102 — Томати середньорослі</option><option value="103">103 — Томати низькорослі</option>';
          } else if (categoryId === '120') { // Cabbage
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option><option value="121">121 — Капуста білокачанна</option><option value="122">122 — Капуста цвітна</option><option value="123">123 — Капуста червонокачанна</option><option value="124">124 — Різновиди капусти</option>';
          } else if (categoryId === '140') { // Pepper
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option><option value="141">141 — Перець солодкий</option><option value="142">142 — Перець гіркий</option>';
          } else if (categoryId === '160') { // Onion
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '170') { // Carrot
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '180') { // Beet
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '190') { // Watermelon
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '200') { // Melon
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '210') { // Pumpkin
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '220') { // Zucchini
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '230') { // Squash
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '240') { // Green crops
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '250') { // Spicy crops
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '260') { // Lawn grass
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '270') { // Bean crops
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '280') { // Beans
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option><option value="281">281 — Квасоля спаржева</option><option value="282">282 — Квасоля зернова</option>';
          } else if (categoryId === '290') { // Corn
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '300') { // Strawberry
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '310') { // Rare cultures
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '320') { // Medicine
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          } else if (categoryId === '330') { // Flowers
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option><option value="331">331 — Квіти однорічні</option><option value="332">332 — Квіти багаторічні</option>';
          } else {
            subcategorySelect.innerHTML = '<option value="">Без підкатегорії</option>';
          }
        }
      }

      // Close modal when clicking outside
      window.onclick = function(event) {
        const modal = document.getElementById('categoryModal');
        if (event.target === modal) {
          closeCategoryModal();
        }
      }

      // Initialize bulk actions
      document.addEventListener('DOMContentLoaded', function() {
        updateBulkActions();
      });
    </script>
  </body>
  </html>

