<!doctype html>
<html lang="uk">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Усі товари</title>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <style>
      .container { max-width: 1400px; margin: 0 auto; }
      table img { height: 56px; width: 56px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
      .controls { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; align-items: end; }
      .nowrap { white-space: nowrap; }
      .sticky { position: sticky; top: 0; background: #fff; }
      th { position: sticky; top: 0; background: #fff; }
      .muted { color: #666; }
    </style>
  </head>
  <body>
    <header class="container">
      <h1>Список усіх товарів</h1>
      <p><a href="{{ url_for('index') }}">← До категорій</a></p>
    </header>
    <main class="container">
      <section>
        <form method="get" class="controls">
          <div>
            <label>Пошук за назвою</label>
            <input type="text" name="q" value="{{ q }}" placeholder="Назва (укр)" />
          </div>
          <div>
            <label>Категорія</label>
            <select name="category_id">
              <option value="">Всі</option>
              {% for c in categories %}
                {% if not c.parentId %}
                  <option value="{{ c.id }}" {% if (filter_category or '') == c.id %}selected{% endif %}>{{ c.id }} — {{ c.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Сортування</label>
            <select name="sort">
              <option value="">ID</option>
              <option value="name" {% if sort_key == 'name' %}selected{% endif %}>Назва</option>
              <option value="category" {% if sort_key == 'category' %}selected{% endif %}>Категорія</option>
            </select>
          </div>
          <div>
            <label>Порядок</label>
            <select name="order">
              <option value="asc" {% if sort_order != 'desc' %}selected{% endif %}>За зростанням</option>
              <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>За спаданням</option>
            </select>
          </div>
          <div>
            <button type="submit">Застосувати</button>
            <a class="muted" href="{{ url_for('products_list') }}">Скинути</a>
          </div>
        </form>
      </section>

      <section>
        <table>
          <thead>
            <tr>
              <th class="nowrap">Зображення</th>
              {% for f in fields %}
                <th>{{ f }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              {% set return_to = request.full_path %}
              <tr>
                <td>
                  <a href="{{ url_for('product_by_id', pid=r['_pid']) }}?return_to={{ return_to | urlencode }}">
                    {% if r._image_url %}
                      <img src="{{ r._image_url }}" alt="image" />
                    {% endif %}
                  </a>
                </td>
                {% for f in fields %}
                  {% set val = r.get(f, '') %}
                  {% if f == 'category_id' %}
                    <td>
                      <a href="{{ url_for('product_by_id', pid=r['_pid']) }}?return_to={{ return_to | urlencode }}">
                        {{ val }}{% if category_name_by_id.get(val) %} — {{ category_name_by_id.get(val) }}{% endif %}
                      </a>
                    </td>
                  {% else %}
                    <td>
                      <a href="{{ url_for('product_by_id', pid=r['_pid']) }}?return_to={{ return_to | urlencode }}">{{ val }}</a>
                    </td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    </main>
  </body>
  </html>

