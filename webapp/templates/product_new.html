<!doctype html>
<html lang="uk">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ù–æ–≤–∏–π —Ç–æ–≤–∞—Ä</title>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <style>
      .container { max-width: 960px; margin: 0 auto; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    </style>
  </head>
  <body>
    <header class="container">
      <h1>–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</h1>
      <a href="{{ url_for('index') }}">‚Üê –î–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π</a>
    </header>
    <main class="container">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <aside>
            {% for m in messages %}<p>{{ m }}</p>{% endfor %}
          </aside>
        {% endif %}
      {% endwith %}

      <form action="{{ url_for('product_create') }}" method="post" enctype="multipart/form-data" id="productForm">
        {% if request.args.get('return_to') %}
          <input type="hidden" name="return_to" value="{{ request.args.get('return_to') }}" />
        {% endif %}
        <div class="grid">
          <div>
            <label>–ù–∞–∑–≤–∞ (—É–∫—Ä) *</label>
            <input type="text" name="–ù–∞–∑–≤–∞–Ω–∏–µ (—É–∫—Ä)" required />
          </div>
          <div>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å)</label>
            <input type="text" name="–ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å)" />
          </div>

          <div>
            <label>–û–ø–∏—Å (—É–∫—Ä) *</label>
            <textarea name="–û–ø–∏—Å–∞–Ω–∏–µ (—É–∫—Ä)" required></textarea>
          </div>
          <div>
            <label>–û–ø–∏—Å–∞–Ω–∏–µ (—Ä—É—Å)</label>
            <textarea name="–û–ø–∏—Å–∞–Ω–∏–µ (—Ä—É—Å)"></textarea>
          </div>

          <div>
            <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è *</label>
            <select name="category_id" required>
              {% for c in categories %}
                {% if not c.parentId %}
                  <option value="{{ c.id }}" {% if c.id == category_id %}selected{% endif %}>{{ c.id }} ‚Äî {{ c.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div>
            <label>–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
            <select name="subcategory_id">
              <option value=""></option>
              {% if category_id %}
                {% for c in parent_to_children.get(category_id|string, []) %}
                  <option value="{{ c.id }}">{{ c.id }} ‚Äî {{ c.name }}</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>

          <div>
            <label>–†—ñ–∫</label>
            <input type="text" name="year" />
          </div>
          <div>
            <label>–ù–∞—è–≤–Ω—ñ—Å—Ç—å</label>
            <select name="availability">
              <option value="">‚Äî</option>
              <option value="0">0 ‚Äî –Ω–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</option>
              <option value="1">1 ‚Äî –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</option>
              <option value="2">2 ‚Äî –ø—ñ–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</option>
            </select>
          </div>

          <div>
            <label>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è *</label>
            <div style="display: flex; gap: 10px; margin: 10px 0;">
              <input type="file" name="image" accept="image/*" required style="flex: 1;" />
              <a href="{{ url_for('library') }}?return_to={{ request.url | urlencode }}" class="button" style="background: #1976d2; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block;">
                üìö –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω—å
              </a>
            </div>
            <input type="hidden" name="selected_library_image" id="selected-library-image" value="" />
          </div>
        </div>
        <button type="submit" id="submitBtn">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
        <div id="loadingMsg" style="display: none; margin-top: 10px; color: #666;">
          –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–æ–≤–∞—Ä... –ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞—á–µ–∫–∞–π—Ç–µ.
        </div>
      </form>

      <script>
        document.getElementById('productForm').addEventListener('submit', function() {
          document.getElementById('submitBtn').disabled = true;
          document.getElementById('submitBtn').textContent = '–°—Ç–≤–æ—Ä—é—î–º–æ...';
          document.getElementById('loadingMsg').style.display = 'block';
        });

        // Handle selected image from library
        document.addEventListener('DOMContentLoaded', function() {
          const selectedLibraryImage = document.getElementById('selected-library-image');
          const fileInput = document.querySelector('input[name="image"]');
          
          // Check if we have a selected image from the library
          const urlParams = new URLSearchParams(window.location.search);
          const selectedImageData = urlParams.get('selected_image');
          
          if (selectedImageData) {
            try {
              const selectedImage = JSON.parse(decodeURIComponent(selectedImageData));
              
              // Set the hidden input value
              selectedLibraryImage.value = JSON.stringify(selectedImage);
              
              // Create an image preview
              const imageContainer = document.querySelector('div:has(input[name="image"])');
              const existingPreview = imageContainer.querySelector('.image-preview');
              if (existingPreview) {
                existingPreview.remove();
              }
              
              const previewDiv = document.createElement('div');
              previewDiv.className = 'image-preview';
              previewDiv.style.marginTop = '10px';
              previewDiv.innerHTML = `
                <img src="${selectedImage.url}" alt="Selected image" style="max-width: 200px; max-height: 200px; object-fit: contain; border-radius: 4px; border: 1px solid #ddd;">
                <div style="margin-top: 5px; font-size: 12px; color: #666;">–í–∏–±—Ä–∞–Ω–æ: ${selectedImage.filename}</div>
              `;
              imageContainer.appendChild(previewDiv);
              
              // Clear the file input since we're using library image
              if (fileInput) {
                fileInput.value = '';
                fileInput.required = false; // Make it not required since we have library image
              }
              
              // Show a success message
              const flashContainer = document.querySelector('aside');
              if (flashContainer) {
                const successMsg = document.createElement('p');
                successMsg.textContent = `–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è "${selectedImage.filename}" –≤–∏–±—Ä–∞–Ω–æ –∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏`;
                successMsg.style.color = '#1976d2';
                successMsg.style.fontWeight = 'bold';
                flashContainer.appendChild(successMsg);
              }
              
              // Clean up the URL
              const newUrl = new URL(window.location);
              newUrl.searchParams.delete('selected_image');
              window.history.replaceState({}, '', newUrl);
              
              console.log('Selected image from library:', selectedImage);
            } catch (error) {
              console.error('Error parsing selected image data:', error);
            }
          }
        });
      </script>
    </main>
  </body>
</html>