<!doctype html>
<html lang="uk">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Перевірка товару</title>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <style>
      .container { max-width: 1200px; margin: 0 auto; }
      .nav { display: flex; justify-content: space-between; align-items: center; }
      .image { max-width: 320px; }
      .image img { width: 100%; border-radius: 8px; border: 1px solid #ddd; }
      .thumbs-vertical { display: flex; flex-direction: column; gap: 8px; max-width: 360px; }
      .thumb-row { display: flex; align-items: center; gap: 10px; }
      .thumb-row img { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
      .thumb-row .meta { font-size: 0.9em; color: #555; word-break: break-all; }
      .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      textarea { min-height: 100px; }
      .muted { color: #666; font-size: 0.9em; }
      .ro { background: #f7f7f7; }
      .page-grid { display: grid; grid-template-columns: 1fr; gap: 24px; align-items: start; }
      .actions { display: flex; gap: 12px; }
    </style>
  </head>
  <body>
    <header class="container nav">
      <div>
        {% if request.args.get('return_to') %}
          <a href="{{ request.args.get('return_to') }}">← Назад до списку</a>
        {% else %}
          <a href="{{ url_for('index') }}">← До категорій</a>
        {% endif %}
      </div>
      <div>Категорія: {{ category_id }}</div>
      <div>{{ index + 1 }} / {{ total }}</div>
    </header>

    <main class="container">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <aside>
            {% for m in messages %}<p>{{ m }}</p>{% endfor %}
          </aside>
        {% endif %}
      {% endwith %}

      {% if not product %}
        <p>Немає товарів для перевірки.</p>
      {% else %}
      <div class="page-grid">
        <article>
          <header>
            <h2>{{ product['Название (укр)'] or 'Без назви' }} <span class="muted">(ID: {{ product['id'] }})</span></h2>
          </header>

          <form action="{{ url_for('product_save', index=index) }}" method="post" enctype="multipart/form-data">
            <input type="hidden" name="id" value="{{ product['id'] }}" />
            {% if request.args.get('return_to') %}
              <input type="hidden" name="return_to" value="{{ request.args.get('return_to') }}" />
            {% endif %}

            <div class="form-grid">
              <div>
                <label>product_id</label>
                <input class="ro" type="text" value="{{ product['product_id'] if product.get('product_id') else '' }}" readonly />
              </div>
              <div></div>

              <div>
                <label>Назва (укр)</label>
                <input type="text" name="Название (укр)" value="{{ product['Название (укр)'] }}" />
              </div>
              <div>
                <label>Название (рус)</label>
                <input type="text" name="Название (рус)" value="{{ product['Название (рус)'] }}" />
              </div>

              <div>
                <label>Опис (укр)</label>
                <textarea name="Описание (укр)" id="textarea-ua">{{ product['Описание (укр)'] }}</textarea>
                <div style="margin-top: 6px;">
                  <button type="button" id="btn-translate-ru-ua">Перекласти з RU → UA</button>
                </div>
              </div>
              <div>
                <label>Описание (рус)</label>
                <textarea name="Описание (рус)" id="textarea-ru">{{ product['Описание (рус)'] }}</textarea>
              </div>

              <div style="grid-column: 1 / -1;">
                <label>Теги</label>
                <div id="tags-editor" class="thumbs-vertical" style="gap:6px;">
                  <div id="tags-list" class="thumb-row" style="flex-wrap: wrap;">
                    {% set raw_tags = (product.get('tags') or '') %}
                    {% set tags = raw_tags.split(',') if raw_tags else [] %}
                    {% for t in tags %}
                      {% set tt = t.strip() %}
                      {% if tt %}
                      {% set label_ua = (tag_ua_map.get(tt) if tag_ua_map else '') %}
                      <span data-tag="{{ tt }}" style="display:inline-flex; align-items:center; gap:4px; padding:4px 6px; border:1px solid #ddd; border-radius:10px; height:44px; font-size:14px; line-height:1;">
                          <span>{{ label_ua or tt }}</span>
                          <button type="button" class="tag-remove"
                            style="font-size:12px; width:20px; height:20px; line-height:18px; padding:0; border:none; background:#1976d2; color:#fff; cursor:pointer; border-radius:50%; display:flex; align-items:center; justify-content:center;"
                            data-tag="{{ tt }}" aria-label="Remove">×</button>
                        </span>
                      {% endif %}
                    {% endfor %}
                  </div>
                  <div class="thumb-row" style="gap:8px;">
                    <input type="text" id="tag-input" placeholder="Додати тег..." />
                    <button type="button" id="tag-add">Додати</button>
                  </div>
                </div>
                <input type="hidden" name="tags" id="tags-hidden" value="{{ (product.get('tags') or '').strip() }}" />
              </div>

              <div>
                <label>Рік</label>
                <input type="text" name="year" value="{{ product['year'] if product.get('year') else '' }}" />
              </div>
              <div>
                <label>Наявність</label>
                <select name="availability">
                  <option value="">—</option>
                  <option value="0" {% if product.get('availability') == '0' %}selected{% endif %}>0 — немає в наявності</option>
                  <option value="1" {% if product.get('availability') == '1' %}selected{% endif %}>1 — в наявності</option>
                  <option value="2" {% if product.get('availability') == '2' %}selected{% endif %}>2 — під замовлення</option>
                </select>
              </div>

              <div>
                <label>Категорія</label>
                <select name="category_id">
                  {% for c in categories %}
                    {% if not c.parentId %}
                      <option value="{{ c.id }}" {% if c.id == product['category_id'] %}selected{% endif %}>{{ c.id }} — {{ c.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
              <div>
                <label>Підкатегорія</label>
                <select name="subcategory_id">
                  <option value=""></option>
                  {% set parent = product['category_id'] %}
                  {% for c in parent_to_children.get(parent, []) %}
                    <option value="{{ c.id }}" {% if c.id == product['subcategory_id'] %}selected{% endif %}>{{ c.id }} — {{ c.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="image" style="grid-column: 1 / -1;">
                <label>Головне зображення</label>
                {% if image_url %}
                  <img src="{{ image_url }}" alt="image" />
                  <label><input type="checkbox" name="remove_primary_image" value="1" /> Видалити поточне</label>
                {% endif %}
                <input type="file" name="image" accept="image/*" />
              </div>

              <div style="grid-column: 1 / -1;">
                <label>Додаткові зображення (до 5)</label>
                {% if secondary_items and secondary_items|length %}
                  <div class="thumbs-vertical">
                    {% for it in secondary_items %}
                      <div class="thumb-row">
                        <img src="{{ it.url }}" alt="secondary" />
                        <div class="meta">{{ it.name }}</div>
                        <label><input type="checkbox" name="remove_images_list" value="{{ it.name }}" /> Видалити</label>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="thumbs-vertical" style="margin-top:8px;">
                  {% for i in range(1,6) %}
                    <div class="thumb-row">
                      <input type="file" name="image_secondary_{{ i }}" accept="image/*" />
                    </div>
                  {% endfor %}
                </div>
              </div>

              <section style="grid-column: 1 / -1;">
                <header>
                  <h3>Інвентар товару</h3>
                  <p class="muted">Керуйте варіантами, цінами та наявністю. Зміни зберігаються разом із товаром.</p>
                </header>

                <div class="thumb-row" style="gap:12px; align-items: flex-end; flex-wrap: wrap;">
                  <div>
                    <label>Загальна наявність</label>
                    <select id="inv-top-availability">
                      <option value="0">0 — Не доступно</option>
                      <option value="1">1 — Очікується</option>
                      <option value="2">2 — Під замовлення</option>
                      <option value="3">3 — В наявності</option>
                    </select>
                  </div>
                  <div>
                    <label>Шаблон варіантів</label>
                    <select id="inv-template-select">
                      <option value="">— Обрати шаблон —</option>
                    </select>
                  </div>
                  <div class="thumb-row" style="gap:8px;">
                    <button type="button" id="inv-add-empty">Додати варіант</button>
                    <button type="button" id="inv-add-from-template">Додати з шаблону</button>
                    <button type="button" id="inv-add-all-from-template">Додати всі значення</button>
                  </div>
                </div>

                <div style="overflow:auto; margin-top:10px;">
                  <table id="inv-table">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Назва (UA)</th>
                        <th>Название (RU)</th>
                        <th>Одиниця</th>
                        <th>Тип</th>
                        <th>Валюта</th>
                        <th>Values</th>
                        <th>Value</th>
                        <th>Ціна</th>
                        <th>Знижка</th>
                        <th>Склад</th>
                        <th>Наявність</th>
                        <th>Дія</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </section>
            </div>

            <input type="hidden" name="inventory_json" id="inventory_json" value="" />

            <footer class="actions">
              <button type="submit" name="action" value="save">Зберегти</button>
              <button type="submit" name="action" value="save_validate">Зберегти і позначити як перевірений</button>
            </footer>
          </form>
          <script>
            window.__TAG_UA_MAP__ = {{ (tag_ua_map or {}) | tojson }};
            (function(){
              const btn = document.getElementById('btn-translate-ru-ua');
              const ru = document.getElementById('textarea-ru');
              const ua = document.getElementById('textarea-ua');
              if (!btn || !ru || !ua) return;
              btn.addEventListener('click', async function(){
                const source = (ru.value || '').trim();
                if (!source) { alert('Немає російського опису для перекладу.'); return; }
                btn.disabled = true; const old = btn.textContent; btn.textContent = 'Перекладаю…';
                try {
                  const resp = await fetch(`${window.location.origin}/api/translate/ru-ua`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: source })
                  });
                  if (!resp.ok) throw new Error('HTTP ' + resp.status);
                  const data = await resp.json();
                  const t = (data && typeof data.translated === 'string') ? data.translated : '';
                  if (t && t.trim().length > 0) {
                    ua.value = t;
                  } else {
                    alert('Не вдалося перекласти опис.');
                  }
                } catch (e) {
                  alert('Помилка перекладу. Спробуйте пізніше.');
                } finally {
                  btn.disabled = false; btn.textContent = old;
                }
              });
            })();

            (function(){
              const hidden = document.getElementById('tags-hidden');
              const list = document.getElementById('tags-list');
              const input = document.getElementById('tag-input');
              const addBtn = document.getElementById('tag-add');
              if (!hidden || !list || !input || !addBtn) return;

              function parseTags() {
                return (hidden.value || '').split(',').map(s => (s || '').trim()).filter(Boolean);
              }

              function translateTag(key) {
                try {
                  const map = (window.__TAG_UA_MAP__ || {});
                  const v = map[key];
                  if (typeof v === 'string' && v.trim()) return v;
                } catch (e) {}
                return key;
              }

              function render() {
                const tags = parseTags();
                list.innerHTML = '';
                for (const tt of tags) {
                  const wrap = document.createElement('span');
                  wrap.setAttribute('data-tag', tt);
                  wrap.setAttribute('style', 'display:inline-flex; align-items:center; gap:4px; padding:4px 6px; border:1px solid #ddd; border-radius:10px; margin:2px; height:44px; font-size:14px; line-height:1;');
                  const label = document.createElement('span');
                  label.textContent = translateTag(tt);
                  const remove = document.createElement('button');
                  remove.type = 'button';
                  remove.className = 'tag-remove';
                  remove.setAttribute('data-tag', tt);
                  remove.textContent = '×';
                  remove.setAttribute('style', 'font-size:12px; width:20px; height:20px; line-height:18px; padding:0; border:none; background:#1976d2; color:#fff; cursor:pointer; border-radius:50%; display:flex; align-items:center; justify-content:center;');
                  remove.addEventListener('click', () => {
                    const cur = parseTags();
                    const next = cur.filter(x => x.toLowerCase() !== tt.toLowerCase());
                    hidden.value = next.join(',');
                    render();
                  });
                  wrap.appendChild(label);
                  wrap.appendChild(remove);
                  list.appendChild(wrap);
                }
              }

              addBtn.addEventListener('click', () => {
                const val = (input.value || '').trim();
                if (!val) return;
                const cur = parseTags();
                if (!cur.find(x => x.toLowerCase() === val.toLowerCase())) {
                  cur.push(val);
                  hidden.value = cur.join(',');
                  render();
                }
                input.value = '';
                input.focus();
              });

              input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); addBtn.click(); }
              });

              render();
            })();

            (function(){
              const form = document.querySelector('form[action*="product_save"]') || document.querySelector('form');
              const invTableBody = document.querySelector('#inv-table tbody');
              const invTopAvailability = document.getElementById('inv-top-availability');
              const invTemplateSelect = document.getElementById('inv-template-select');
              const btnAddEmpty = document.getElementById('inv-add-empty');
              const btnAddFromTemplate = document.getElementById('inv-add-from-template');
              const btnAddAllFromTemplate = document.getElementById('inv-add-all-from-template');
              const hiddenInv = document.getElementById('inventory_json');
              if (!invTableBody || !invTopAvailability || !invTemplateSelect || !hiddenInv) return;

              const productId = ({{ product['id']|tojson }});
              const productSku = ({{ (product.get('product_id') or '')|tojson }});

              const defaultTemplates = (
                {{ [
                  {
                    'title': { 'ua': 'Маленький пакет', 'ru': 'Маленький пакет' },
                    'type': 'quantity', 'unit': 'pcs', 'values': [10, 15, 20, 25, 30]
                  },
                  {
                    'title': { 'ua': 'Великий пакет', 'ru': 'Большой пакет' },
                    'type': 'weight', 'unit': 'g', 'values': [50, 100, 250, 500]
                  }
                ] | tojson }}
              );

              // Initial inventory from backend
              const initialInventory = ({{ (inventory or {})|tojson }});
              const state = {
                availability: (initialInventory && typeof initialInventory.availability === 'number') ? initialInventory.availability : 0,
                items: Array.isArray(initialInventory.items) ? initialInventory.items.slice() : []
              };

              function optionAvailability(value) {
                const o = document.createElement('option');
                o.value = String(value);
                const map = {
                  0: '0 — Не доступно',
                  1: '1 — Очікується',
                  2: '2 — Під замовлення',
                  3: '3 — В наявності'
                };
                o.textContent = map[value] || String(value);
                return o;
              }

              function renderTemplates() {
                invTemplateSelect.innerHTML = '<option value="">— Обрати шаблон —</option>';
                defaultTemplates.forEach((t, idx) => {
                  const opt = document.createElement('option');
                  opt.value = String(idx);
                  opt.textContent = `${t.title.ua} (${t.unit})`;
                  invTemplateSelect.appendChild(opt);
                });
              }

              function createRow(item) {
                const tr = document.createElement('tr');
                tr.dataset.id = item.id || '';
                function td(inner) { const c = document.createElement('td'); if (inner) c.appendChild(inner); return c; }
                function inp(type, value, placeholder) { const i = document.createElement('input'); i.type = type; if (value !== undefined && value !== null) i.value = String(value); if (placeholder) i.placeholder = placeholder; return i; }
                function sel(options, value) { const s = document.createElement('select'); options.forEach(o => { const opt = document.createElement('option'); opt.value = o.value; opt.textContent = o.label; s.appendChild(opt); }); if (value !== undefined && value !== null) s.value = String(value); return s; }

                // id (readonly text)
                const idInput = inp('text', item.id || '', ''); idInput.readOnly = true; idInput.className = 'ro';
                tr.appendChild(td(idInput));
                // title ua
                tr.appendChild(td(inp('text', (item.title && item.title.ua) || '', 'Назва (UA)')));
                // title ru
                tr.appendChild(td(inp('text', (item.title && item.title.ru) || '', 'Название (RU)')));
                // unit
                tr.appendChild(td(inp('text', item.unit || '', 'pcs / g')));
                // type
                const typeSel = sel([
                  {value:'', label:'—'},
                  {value:'quantity', label:'quantity'},
                  {value:'weight', label:'weight'}
                ], item.type || '');
                tr.appendChild(td(typeSel));
                // currency
                const curSel = sel([
                  {value:'UAH', label:'UAH'},
                  {value:'USD', label:'USD'},
                  {value:'EUR', label:'EUR'}
                ], item.currency || 'UAH');
                tr.appendChild(td(curSel));
                // values (csv)
                const valuesInput = inp('text', Array.isArray(item.values) ? item.values.join(',') : '', 'наприклад: 1,10');
                tr.appendChild(td(valuesInput));
                // value
                const valueInput = inp('number', item.value != null ? item.value : '', ''); valueInput.step = 'any';
                tr.appendChild(td(valueInput));
                // original price
                const opInput = inp('number', item.original_price != null ? item.original_price : '', ''); opInput.step = 'any';
                tr.appendChild(td(opInput));
                // sale price
                const spInput = inp('number', item.sale_price != null ? item.sale_price : '', ''); spInput.step = 'any';
                tr.appendChild(td(spInput));
                // stock qty
                const sqInput = inp('number', item.stock_qty != null ? item.stock_qty : '', ''); sqInput.step = '1';
                tr.appendChild(td(sqInput));
                // availability
                const avSel = document.createElement('select');
                [0,1,2,3].forEach(v => avSel.appendChild(optionAvailability(v)));
                avSel.value = String((typeof item.availability === 'number') ? item.availability : 0);
                tr.appendChild(td(avSel));
                // actions
                const remBtn = document.createElement('button'); remBtn.type = 'button'; remBtn.textContent = '✕';
                remBtn.addEventListener('click', () => { tr.remove(); syncStateFromDOM(); });
                tr.appendChild(td(remBtn));

                tr._controls = { idInput, typeSel, curSel, valuesInput, valueInput, opInput, spInput, sqInput, avSel };
                invTableBody.appendChild(tr);
              }

              function render() {
                invTopAvailability.value = String(state.availability || 0);
                invTableBody.innerHTML = '';
                (state.items || []).forEach(it => createRow(it));
              }

              function parseCsvValues(text) {
                const arr = String(text || '').split(',').map(s => s.trim()).filter(Boolean).map(v => {
                  const n = Number(v); return Number.isFinite(n) ? n : v;
                });
                return arr;
              }

              function syncStateFromDOM() {
                state.availability = Number(invTopAvailability.value || 0) || 0;
                const rows = Array.from(invTableBody.querySelectorAll('tr'));
                state.items = rows.map(tr => {
                  const c = tr._controls || {};
                  const titleUa = tr.children[1].querySelector('input').value || '';
                  const titleRu = tr.children[2].querySelector('input').value || '';
                  const unit = tr.children[3].querySelector('input').value || '';
                  const type = c.typeSel ? c.typeSel.value : '';
                  const currency = c.curSel ? c.curSel.value : 'UAH';
                  const valuesCsv = c.valuesInput ? c.valuesInput.value : '';
                  const values = parseCsvValues(valuesCsv);
                  const value = c.valueInput && c.valueInput.value !== '' ? Number(c.valueInput.value) : null;
                  const original_price = c.opInput && c.opInput.value !== '' ? Number(c.opInput.value) : null;
                  const sale_price = c.spInput && c.spInput.value !== '' ? Number(c.spInput.value) : null;
                  const stock_qty = c.sqInput && c.sqInput.value !== '' ? Number(c.sqInput.value) : 0;
                  const availability = c.avSel ? Number(c.avSel.value || 0) : 0;
                  const id = c.idInput ? c.idInput.value : '';
                  return { id, title: { ua: titleUa, ru: titleRu }, unit, type, currency, values, value, original_price, sale_price, stock_qty, availability };
                });
                hiddenInv.value = JSON.stringify({ id: productId, product_id: productSku, availability: state.availability, items: state.items });
              }

              function addEmpty() {
                const it = { id: '', title: { ua: '', ru: '' }, original_price: null, sale_price: null, currency: 'UAH', stock_qty: 0, value: null, unit: '', type: '', values: [], availability: 0 };
                state.items.push(it);
                createRow(it);
                syncStateFromDOM();
              }

              function addFromTemplate(allValues) {
                const idx = invTemplateSelect.value ? Number(invTemplateSelect.value) : NaN;
                if (!Number.isFinite(idx)) { addEmpty(); return; }
                const t = defaultTemplates[idx]; if (!t) { addEmpty(); return; }
                const vals = Array.isArray(t.values) ? t.values.slice() : [];
                const addSet = allValues ? (vals.length ? vals : [null]) : [vals.length ? vals[0] : null];
                addSet.forEach(v => {
                  const it = {
                    id: '',
                    title: { ua: t.title.ua || '', ru: t.title.ru || '' },
                    original_price: null,
                    sale_price: null,
                    currency: 'UAH',
                    stock_qty: 0,
                    value: v,
                    unit: t.unit || '',
                    type: t.type || '',
                    values: vals,
                    availability: 0
                  };
                  state.items.push(it);
                  createRow(it);
                });
                syncStateFromDOM();
              }

              // Wire events
              btnAddEmpty && btnAddEmpty.addEventListener('click', () => { addEmpty(); });
              btnAddFromTemplate && btnAddFromTemplate.addEventListener('click', () => { addFromTemplate(false); });
              btnAddAllFromTemplate && btnAddAllFromTemplate.addEventListener('click', () => { addFromTemplate(true); });
              invTopAvailability.addEventListener('change', syncStateFromDOM);

              if (form) {
                form.addEventListener('submit', () => { syncStateFromDOM(); });
              }

              // Init
              renderTemplates();
              render();
              syncStateFromDOM();
            })();
          </script>
        </article>
      </div>
      {% endif %}
    </main>
  </body>
</html>
