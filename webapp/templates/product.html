<!doctype html>
<html lang="uk">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–≤–∞—Ä—É</title>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <style>
      .container { max-width: 1200px; margin: 0 auto; }
      .nav { display: flex; justify-content: space-between; align-items: center; }
      .image { max-width: 320px; }
      .image img { width: 100%; border-radius: 8px; border: 1px solid #ddd; }
      .thumbs-vertical { display: flex; flex-direction: column; gap: 8px; max-width: 360px; }
      .thumb-row { display: flex; align-items: center; gap: 10px; }
      .thumb-row img { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
      .thumb-row .meta { font-size: 0.9em; color: #555; word-break: break-all; }
      .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      textarea { min-height: 100px; }
      .muted { color: #666; font-size: 0.9em; }
      .ro { background: #f7f7f7; }
      .page-grid { display: grid; grid-template-columns: 1fr; gap: 24px; align-items: start; }
      .actions { display: flex; gap: 12px; }
    </style>
  </head>
  <body>
    <header class="container nav">
      <div>
        {% if request.args.get('return_to') %}
          <a href="{{ request.args.get('return_to') }}">‚Üê –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</a>
        {% else %}
          <a href="{{ url_for('category', category_id=category_id) }}">‚Üê –î–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</a>
        {% endif %}
      </div>
      <div>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: {{ category_id }}</div>
      <div>{{ index + 1 }} / {{ total }}</div>
    </header>

    <main class="container">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <aside>
            {% for m in messages %}<p>{{ m }}</p>{% endfor %}
          </aside>
        {% endif %}
      {% endwith %}

      {% if not product %}
        <p>–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏.</p>
      {% else %}
      <div class="page-grid" style="grid-template-columns: 2fr 1fr;">
        <article>
          <header>
            <h2>{{ product['–ù–∞–∑–≤–∞–Ω–∏–µ (—É–∫—Ä)'] or '–ë–µ–∑ –Ω–∞–∑–≤–∏' }} <span class="muted">(ID: {{ product['id'] }})</span></h2>
            {% set inv_return = request.full_path %}
            <p><a class="button" href="{{ url_for('inventory_edit', pid=product['id']) }}?return_to={{ inv_return | urlencode }}">–°–∫–ª–∞–¥</a></p>
          </header>

          <form action="{{ url_for('product_save', index=index) }}" method="post" enctype="multipart/form-data">
            <input type="hidden" name="id" value="{{ product['id'] }}" />
            {% if request.args.get('return_to') %}
              <input type="hidden" name="return_to" value="{{ request.args.get('return_to') }}" />
            {% endif %}

            <div class="form-grid">
              <div>
                <label>product_id</label>
                <input class="ro" type="text" value="{{ product['product_id'] if product.get('product_id') else '' }}" readonly />
              </div>
              <div></div>
              
              <div style="grid-column: 1 / -1;">
                <label>SEO</label>
                <input type="text" name="seo" value="{{ product.get('seo') or '' }}" placeholder="–ù–∞–ø—Ä., amurskyj-tyhr" />
                <div class="muted">–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è SEO-URL (OpenCart oc_seo_url). –õ–∞—Ç–∏–Ω–∏—Ü—è, –±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤.</div>
              </div>
              
              <div>
                <label>–ù–∞–∑–≤–∞ (—É–∫—Ä)</label>
                <input type="text" name="–ù–∞–∑–≤–∞–Ω–∏–µ (—É–∫—Ä)" value="{{ product['–ù–∞–∑–≤–∞–Ω–∏–µ (—É–∫—Ä)'] }}" />
              </div>
              <div>
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å)</label>
                <input type="text" name="–ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å)" value="{{ product['–ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å)'] }}" />
              </div>

              <div>
                <label>–û–ø–∏—Å (—É–∫—Ä)</label>
                <textarea name="–û–ø–∏—Å–∞–Ω–∏–µ (—É–∫—Ä)" id="textarea-ua">{{ product['–û–ø–∏—Å–∞–Ω–∏–µ (—É–∫—Ä)'] }}</textarea>
                <div style="margin-top: 6px;">
                  <button type="button" id="btn-translate-ru-ua">–ü–µ—Ä–µ–∫–ª–∞—Å—Ç–∏ –∑ RU ‚Üí UA</button>
                </div>
              </div>
              <div>
                <label>–û–ø–∏—Å–∞–Ω–∏–µ (—Ä—É—Å)</label>
                <textarea name="–û–ø–∏—Å–∞–Ω–∏–µ (—Ä—É—Å)" id="textarea-ru">{{ product['–û–ø–∏—Å–∞–Ω–∏–µ (—Ä—É—Å)'] }}</textarea>
              </div>

              <div style="grid-column: 1 / -1;">
                <label>–¢–µ–≥–∏</label>
                <div id="tags-editor" class="thumbs-vertical" style="gap:6px;">
                  <div id="tags-list" class="thumb-row" style="flex-wrap: wrap;">
                    {% set raw_tags = (product.get('tags') or '') %}
                    {% set tags = raw_tags.split(',') if raw_tags else [] %}
                    {% for t in tags %}
                      {% set tt = t.strip() %}
                      {% if tt %}
                      {% set label_ua = (tag_ua_map.get(tt) if tag_ua_map else '') %}
                      <span data-tag="{{ tt }}" style="display:inline-flex; align-items:center; gap:4px; padding:4px 6px; border:1px solid #ddd; border-radius:10px; height:44px; font-size:14px; line-height:1;">
                          <span>{{ label_ua or tt }}</span>
                          <button type="button" class="tag-remove"
                            style="font-size:12px; width:20px; height:20px; line-height:18px; padding:0; border:none; background:#1976d2; color:#fff; cursor:pointer; border-radius:50%; display:flex; align-items:center; justify-content:center;"
                            data-tag="{{ tt }}" aria-label="Remove">√ó</button>
                        </span>
                      {% endif %}
                    {% endfor %}
                  </div>
                  <div class="thumb-row" style="gap:8px;">
                    <input type="text" id="tag-input" placeholder="–î–æ–¥–∞—Ç–∏ —Ç–µ–≥..." />
                    <button type="button" id="tag-add">–î–æ–¥–∞—Ç–∏</button>
                  </div>
                </div>
                <input type="hidden" name="tags" id="tags-hidden" value="{{ (product.get('tags') or '').strip() }}" />
              </div>

              <div>
                <label>–†—ñ–∫</label>
                <input type="text" name="year" value="{{ product['year'] if product.get('year') else '' }}" />
              </div>
              <div>
                <label>–ù–∞—è–≤–Ω—ñ—Å—Ç—å</label>
                <select name="availability">
                  <option value="">‚Äî</option>
                  <option value="0" {% if product.get('availability') == '0' %}selected{% endif %}>0 ‚Äî –Ω–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</option>
                  <option value="1" {% if product.get('availability') == '1' %}selected{% endif %}>1 ‚Äî –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</option>
                  <option value="2" {% if product.get('availability') == '2' %}selected{% endif %}>2 ‚Äî –ø—ñ–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</option>
                </select>
              </div>

              <div>
                <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                <select name="category_id">
                  {% for c in categories %}
                    {% if not c.parentId %}
                      <option value="{{ c.id }}" {% if c.id == product['category_id'] %}selected{% endif %}>{{ c.id }} ‚Äî {{ c.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
              <div>
                <label>–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                <select name="subcategory_id">
                  <option value=""></option>
                  {% set parent = product['category_id'] %}
                  {% for c in parent_to_children.get(parent, []) %}
                    <option value="{{ c.id }}" {% if c.id == product['subcategory_id'] %}selected{% endif %}>{{ c.id }} ‚Äî {{ c.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label>–¶—ñ–Ω–∞ (price)</label>
                <input type="text" name="price" value="{{ product.get('price') or '' }}" placeholder="e.g. 25.50" />
                <div class="muted">–ë–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞ —Ç–æ–≤–∞—Ä—É. –î–ª—è –¥—ñ–∞–ø–∞–∑–æ–Ω—É —Ü—ñ–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –æ–ø—Ü—ñ—ó –≤ "–°–∫–ª–∞–¥".</div>
              </div>
              <div>
                <label>–í–∞–≥–∞ (–≥—Ä–∞–º)</label>
                <input type="text" name="weight" value="{{ product.get('weight') or '' }}" placeholder="e.g. 0.10" />
              </div>

              <div class="image" style="grid-column: 1 / -1;">
                <label>–ì–æ–ª–æ–≤–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                {% if image_url %}
                  <img src="{{ image_url }}" alt="image" />
                  <label><input type="checkbox" name="remove_primary_image" value="1" /> –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–µ</label>
                {% endif %}
                <div style="display: flex; gap: 10px; margin: 10px 0;">
                  <input type="file" name="image" accept="image/*" style="flex: 1;" />
                  <a href="{{ url_for('library') }}?return_to={{ request.url | urlencode }}" class="button" style="background: #1976d2; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block;">
                    üìö –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω—å
                  </a>
                </div>
                <input type="hidden" name="selected_library_image" id="selected-library-image" value="" />
              </div>

              <div style="grid-column: 1 / -1;">
                <label>–î–æ–¥–∞—Ç–∫–æ–≤—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–¥–æ 5)</label>
                {% if secondary_items and secondary_items|length %}
                  <div class="thumbs-vertical">
                    {% for it in secondary_items %}
                      <div class="thumb-row">
                        <img src="{{ it.url }}" alt="secondary" />
                        <div class="meta">{{ it.name }}</div>
                        <label><input type="checkbox" name="remove_images_list" value="{{ it.name }}" /> –í–∏–¥–∞–ª–∏—Ç–∏</label>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="thumbs-vertical" style="margin-top:8px;">
                  {% for i in range(1,6) %}
                    <div class="thumb-row">
                      <input type="file" name="image_secondary_{{ i }}" accept="image/*" />
                    </div>
                  {% endfor %}
                </div>
              </div>

            </div>

            <footer class="actions">
              <button type="submit" name="action" value="save">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
              <button type="submit" name="action" value="save_validate">–ó–±–µ—Ä–µ–≥—Ç–∏ —ñ –ø–æ–∑–Ω–∞—á–∏—Ç–∏ —è–∫ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–∏–π</button>
            </footer>
          </form>
          <script>
            window.__TAG_UA_MAP__ = {{ (tag_ua_map or {}) | tojson }};
            (function(){
              const btn = document.getElementById('btn-translate-ru-ua');
              const ru = document.getElementById('textarea-ru');
              const ua = document.getElementById('textarea-ua');
              if (!btn || !ru || !ua) return;
              btn.addEventListener('click', async function(){
                const source = (ru.value || '').trim();
                if (!source) { alert('–ù–µ–º–∞—î —Ä–æ—Å—ñ–π—Å—å–∫–æ–≥–æ –æ–ø–∏—Å—É –¥–ª—è –ø–µ—Ä–µ–∫–ª–∞–¥—É.'); return; }
                btn.disabled = true; const old = btn.textContent; btn.textContent = '–ü–µ—Ä–µ–∫–ª–∞–¥–∞—é‚Ä¶';
                try {
                  const resp = await fetch(`${window.location.origin}/api/translate/ru-ua`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: source })
                  });
                  if (!resp.ok) throw new Error('HTTP ' + resp.status);
                  const data = await resp.json();
                  const t = (data && typeof data.translated === 'string') ? data.translated : '';
                  if (t && t.trim().length > 0) {
                    ua.value = t;
                  } else {
                    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–∫–ª–∞—Å—Ç–∏ –æ–ø–∏—Å.');
                  }
                } catch (e) {
                  alert('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–∫–ª–∞–¥—É. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.');
                } finally {
                  btn.disabled = false; btn.textContent = old;
                }
              });
            })();

            (function(){
              const hidden = document.getElementById('tags-hidden');
              const list = document.getElementById('tags-list');
              const input = document.getElementById('tag-input');
              const addBtn = document.getElementById('tag-add');
              if (!hidden || !list || !input || !addBtn) return;

              function parseTags() {
                return (hidden.value || '').split(',').map(s => (s || '').trim()).filter(Boolean);
              }

              function translateTag(key) {
                try {
                  const map = (window.__TAG_UA_MAP__ || {});
                  const v = map[key];
                  if (typeof v === 'string' && v.trim()) return v;
                } catch (e) {}
                return key;
              }

              function render() {
                const tags = parseTags();
                list.innerHTML = '';
                for (const tt of tags) {
                  const wrap = document.createElement('span');
                  wrap.setAttribute('data-tag', tt);
                  wrap.setAttribute('style', 'display:inline-flex; align-items:center; gap:4px; padding:4px 6px; border:1px solid #ddd; border-radius:10px; margin:2px; height:44px; font-size:14px; line-height:1;');
                  const label = document.createElement('span');
                  label.textContent = translateTag(tt);
                  const remove = document.createElement('button');
                  remove.type = 'button';
                  remove.className = 'tag-remove';
                  remove.setAttribute('data-tag', tt);
                  remove.textContent = '√ó';
                  remove.setAttribute('style', 'font-size:12px; width:20px; height:20px; line-height:18px; padding:0; border:none; background:#1976d2; color:#fff; cursor:pointer; border-radius:50%; display:flex; align-items:center; justify-content:center;');
                  remove.addEventListener('click', () => {
                    const cur = parseTags();
                    const next = cur.filter(x => x.toLowerCase() !== tt.toLowerCase());
                    hidden.value = next.join(',');
                    render();
                  });
                  wrap.appendChild(label);
                  wrap.appendChild(remove);
                  list.appendChild(wrap);
                }
              }

              addBtn.addEventListener('click', () => {
                const val = (input.value || '').trim();
                if (!val) return;
                const cur = parseTags();
                if (!cur.find(x => x.toLowerCase() === val.toLowerCase())) {
                  cur.push(val);
                  hidden.value = cur.join(',');
                  render();
                }
                input.value = '';
                input.focus();
              });

              input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); addBtn.click(); }
              });

              render();
            })();

            // Inventory panel moved to dedicated screen
          </script>
        </article>
        <aside>
          <header>
            <h3>–°–∫–ª–∞–¥</h3>
          </header>
          {% set inv = inventory or {} %}
          {% set items = inv.get('items') or [] %}
          {% if not items %}
            <p class="muted">–ù–µ–º–∞—î –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ —Å–∫–ª–∞–¥—É –¥–ª—è —Ü—å–æ–≥–æ —Ç–æ–≤–∞—Ä—É.</p>
          {% else %}
            <div style="display:flex; flex-direction: column; gap: 8px;">
              {% for it in items %}
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 8px;">
                  <div style="font-weight: 600;">{{ (it.title.ua or it.title.ru or '') if it.title else '' }}</div>
                  <div class="muted">
                    {{ it.type or '' }}
                    {% if it.value is not none %} ‚Ä¢ {{ it.value }}{% endif %}
                    {% if it.unit %} {{ it.unit }}{% endif %}
                  </div>
                  <div class="muted">
                    {{ (it.original_price if it.original_price is not none else '‚Äî') }} {{ it.currency or 'UAH' }}
                    {% if it.sale_price is not none %}
                      ‚Ä¢ –∑–Ω–∏–∂–∫–∞: {{ it.sale_price }} {{ it.currency or 'UAH' }}
                    {% endif %}
                  </div>
                  <div class="muted">–°–∫–ª–∞–¥: {{ it.stock_qty if it.stock_qty is not none else 0 }}</div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
          <div style="margin-top: 12px;">
            <a class="button" href="{{ url_for('inventory_edit', pid=product['id']) }}">–í—ñ–¥–∫—Ä–∏—Ç–∏ "–°–∫–ª–∞–¥"</a>
          </div>
        </aside>
      </div>
      {% endif %}
    </main>

    <!-- Include Image Library Component -->
    {% include 'image_library.html' %}

    <script>
      // Handle selected image from library
      document.addEventListener('DOMContentLoaded', function() {
        const selectedLibraryImage = document.getElementById('selected-library-image');
        const fileInput = document.querySelector('input[name="image"]');
        
        // Check if we have a selected image from the library
        const urlParams = new URLSearchParams(window.location.search);
        const selectedImageData = urlParams.get('selected_image');
        
        if (selectedImageData) {
          try {
            const selectedImage = JSON.parse(decodeURIComponent(selectedImageData));
            
            // Set the hidden input value
            selectedLibraryImage.value = JSON.stringify(selectedImage);
            
            // Update the image preview
            const imagePreview = document.querySelector('.image img');
            if (imagePreview) {
              imagePreview.src = selectedImage.url;
              imagePreview.style.display = 'block';
            } else {
              // Create a new image preview if none exists
              const imageContainer = document.querySelector('.image');
              const newImg = document.createElement('img');
              newImg.src = selectedImage.url;
              newImg.alt = 'Selected image';
              newImg.style.maxWidth = '320px';
              newImg.style.width = '100%';
              newImg.style.borderRadius = '8px';
              newImg.style.border = '1px solid #ddd';
              imageContainer.appendChild(newImg);
            }
            
            // Clear the file input since we're using library image
            if (fileInput) {
              fileInput.value = '';
            }
            
            // Show a success message
            const flashContainer = document.querySelector('aside');
            if (flashContainer) {
              const successMsg = document.createElement('p');
              successMsg.textContent = `–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è "${selectedImage.filename}" –≤–∏–±—Ä–∞–Ω–æ –∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏`;
              successMsg.style.color = '#1976d2';
              successMsg.style.fontWeight = 'bold';
              flashContainer.appendChild(successMsg);
            }
            
            // Clean up the URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('selected_image');
            window.history.replaceState({}, '', newUrl);
            
            console.log('Selected image from library:', selectedImage);
          } catch (error) {
            console.error('Error parsing selected image data:', error);
          }
        }
      });
    </script>
  </body>
</html>
